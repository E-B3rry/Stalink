redComSides = {
  ["left"] = {},
  ["right"] = {},
  ["up"] = {},
  ["down"] = {},
  ["front"] = {},
  ["back"] = {}
}

function isOpen(channel, sides)
  if type(channel) != "number" then
    error("Channel argument must be a number.", 2)
  elseif channel < 1 or channel > 65535 then
    error("Channel out of range [1 - 65535], got " .. channel .. ".", 2)
  end

  if type(sides) == "string" then
    sides = {sides}
  elseif type(sides) ~= "table" then
    sides = {"left", "right", "up", "down", "front", "back"}
  end

  for side in sides do
    for openedChannel in redComSides[side] do
      if channel == openedChannel then
        return true
      end
    end
  end

  return false
end

function getOpenableModemSide()
  for side, channels in ipairs(redComSides) do
    if peripheral.getType(side) == "modem" then
      if #channels < 128 then
        return side
      end
    end
  end

  return nil
end

function open(channels, side)
  local notSpecifiedSide = false

  if side then
    local t = peripheral.getType(side)
    if t == nil then
      error("No peripheral detected on side " .. side .. ".", 2)
    elseif t ~= "modem"
      error("The peripheral connected to side " .. side .. " is not a modem.", 2)
    end

    if #(redComSides[side]) > 127 then
      error("The " .. side .. " modem cannot open another channel (128 already in use).", 2)
    end
  else
    side = getOpenableModemSide()
    notSpecifiedSide = true

    if not side then
      error("There aren't any modem connected to the computer that can open channel.", 2)
    end
  end

  if type(channels) == "number" then
    peripheral.call(side, "open", channels)
    redComSides[side].insert(channels)
  elseif type(channels) == "table" then
    for channel in channels do
      if isOpen(channel) then
        goto open_function_continue_statment
      end

      if #(redComSides[side]) > 127 then
        if notSpecifiedSide then
          side = getOpenableModemSide()

          if not side then
            error("Couldn't open all channels because there aren't any modems connected to the computer that can open channel anymore. (All the modems have 128 channels in use)", 2)
          end
        else
          error("Couldn't open all channels because " .. side .. " modem cannot open another channel (128 already in use).", 2)
        end
      end

      peripheral.call(side, "open", channel)
      redComSides[side].insert(channel)

      ::open_function_continue_statment::
    end
  else
    error("Expected number or table of numbers for channels argument.", 2)
  end

  return true
end
